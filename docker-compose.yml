# Docker Compose configurado para Portainer

networks:
  erp-network:
    driver: bridge
    labels:
      - "com.portainer.network.description=Rede do Sistema ERP"

volumes:
  erp-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "../Banco de dados Aqui"
    labels:
      - "com.portainer.volume.description=Volume de dados do ERP"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: erp-gestao-vendas
    hostname: erp-app
    
    # Labels para Portainer
    labels:
      - "com.portainer.stack.name=erp-gestao-vendas"
      - "com.portainer.service.description=Sistema ERP de GestÃ£o de Vendas"
      - "com.portainer.service.version=1.0.0"
      - "com.portainer.service.maintainer=Sistema ERP Team"
      - "com.portainer.service.category=business"
      - "traefik.enable=false"
      - "app.name=ERP GestÃ£o Vendas"
      - "app.description=Sistema completo de gestÃ£o empresarial"
      - "app.version=1.0.0"
    
    environment:
      - NODE_ENV=production
      - PORT=3145
      - DB_PATH=/data/erp.sqlite
      - NEXT_PUBLIC_API_URL=http://localhost:3145/api
      - NEXT_TELEMETRY_DISABLED=1
      - TZ=America/Sao_Paulo
      - CONTAINER_NAME=erp-gestao-vendas
    
    ports:
      - "3145:3145"
    
    volumes:
      - erp-data:/data:rw
    
    networks:
      - erp-network
    
    restart: unless-stopped
    
    # Resource limits (for Portainer monitoring)
    mem_limit: 512m
    cpus: 1.0
    
    # Healthcheck melhorado
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3145/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    command: >
      sh -c "
        echo 'ğŸš€ Iniciando Sistema ERP-BR...'
        echo 'ğŸ“Š Verificando permissÃµes do banco de dados...'
        chmod -R 777 /data 2>/dev/null || true
        echo 'ğŸ’¾ Banco de dados localizado em: /data'
        ls -la /data/
        echo 'âš¡ Executando servidor em modo produÃ§Ã£o na porta 3145...'
        echo 'ğŸŒ Acesse: http://localhost:3145'
        npm start
      "
